\documentclass[tikz,border=10pt]{standalone}
\usetikzlibrary{shapes.geometric, arrows.meta, positioning, fit, backgrounds}

\begin{document}

\tikzset{
    process/.style={rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!20, text width=4.5cm},
    decision/.style={diamond, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=orange!20, text width=2.5cm, aspect=2},
    startstop/.style={rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=red!20},
    arrow/.style={thick,->,>=Stealth},
}

\begin{tikzpicture}[node distance=1.2cm]

% EXEC subgraph nodes
\node (A1) [process] {surface\_processes() called};
\node (B1) [decision, below=of A1] {GoSPL driver initialized?};
\node (C1) [startstop, right=3cm of B1] {Return (skip)};
\node (D1) [process, below=of B1] {Calculate dt\_years};
\node (E1) [process, below=of D1] {Accumulate: accumulated\_dt += dt};
\node (F1) [process, below=of E1] {Increment: step\_counter++};
\node (G1) [decision, below=of F1] {step\_counter $<$ coupling\_frequency?};
\node (H1) [startstop, right=3cm of G1] {Return early (skip coupling)};
\node (I1) [process, below=of G1] {Reset counters};
\node (J1) [process, below=of I1] {Extract surface node coords};

% COUPLE subgraph nodes
\node (K1) [process, below=of J1] {Step 1: Apply DES elevation to GoSPL\\(apply\_elevation\_data)};
\node (L1) [process, below=of K1] {Step 2: Get GoSPL elevation BEFORE\\(interpolate\_elevation\_to\_points)};
\node (M1) [process, below=of L1] {Step 3: Run GoSPL erosion\\(run\_processes\_for\_dt)};
\node (N1) [process, below=of M1] {Step 4: Get GoSPL elevation AFTER\\(interpolate\_elevation\_to\_points)};
\node (O1) [process, below=of N1] {Step 5: Compute erosion\\= after - before};

% APPLY subgraph nodes
\node (P1) [decision, below=of O1] {Node in bounds?};
\node (Q1) [process, right=3cm of P1] {Skip node};
\node (R1) [process, below=of P1] {Apply erosion to DES:\\coord[z] += erosion};
\node (S1) [process, below=1.8cm of Q1] {Next node};
\node (T1) [decision, below=of S1] {More nodes?};
\node (U1) [process, below=of T1] {Log statistics};
\node (V1) [startstop, below=of U1] {Done};

% Arrows
\draw [arrow] (A1) -- (B1);
\draw [arrow] (B1) -- node[anchor=south] {No} (C1);
\draw [arrow] (B1) -- node[anchor=east] {Yes} (D1);
\draw [arrow] (D1) -- (E1);
\draw [arrow] (E1) -- (F1);
\draw [arrow] (F1) -- (G1);
\draw [arrow] (G1) -- node[anchor=south] {Yes} (H1);
\draw [arrow] (G1) -- node[anchor=east] {No} (I1);
\draw [arrow] (I1) -- (J1);
\draw [arrow] (J1) -- (K1);
\draw [arrow] (K1) -- (L1);
\draw [arrow] (L1) -- (M1);
\draw [arrow] (M1) -- (N1);
\draw [arrow] (N1) -- (O1);
\draw [arrow] (O1) -- (P1);
\draw [arrow] (P1) -- node[anchor=south] {No} (Q1);
\draw [arrow] (P1) -- node[anchor=east] {Yes} (R1);
\draw [arrow] (Q1) -- (S1);
\draw [arrow] (R1) -- (S1);
\draw [arrow] (S1) -- (T1);
\draw [arrow] (T1.west) -- ++(-1.5,0) |- node[anchor=south, pos=0.25] {Yes} (P1.west);
\draw [arrow] (T1) -- node[anchor=east] {No} (U1);
\draw [arrow] (U1) -- (V1);

% Background boxes for subgraphs
\begin{pgfonlayer}{background}
    \node [draw=blue!50, fill=blue!5, thick, dotted, fit={(A1) (J1)}, inner sep=0.3cm, label=above:EXEC: Coupling Execution Each Step] (exec) {};
    \node [draw=green!50, fill=green!5, thick, dotted, fit={(K1) (O1)}, inner sep=0.3cm, label=above:COUPLE: Coupling Steps] (couple) {};
    \node [draw=red!50, fill=red!5, thick, dotted, fit={(P1) (Q1) (R1) (S1) (T1) (U1) (V1)}, inner sep=0.3cm, label=above:APPLY: Apply Changes] (apply) {};
\end{pgfonlayer}

\end{tikzpicture}

\end{document}